<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Caffeine Rush v0.07: Designs Restored</title>
    <style>
        /* --- CORE STYLES --- */
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');

        :root { --neon-green: #00ff00; --neon-yellow: #ffff00; --dark-bg: #1a1a1a; }
        
        body {
            margin: 0; overflow: hidden; background-color: var(--dark-bg);
            font-family: 'Press Start 2P', 'Courier New', Courier, monospace; 
            touch-action: none; user-select: none; -webkit-user-select: none;
        }
        #gameCanvas { display: block; }

        /* --- UI LAYER --- */
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column;
            justify-content: space-between; z-index: 10;
        }

        .hud {
            padding: 20px; color: white; text-shadow: 2px 2px 0 #000;
            display: flex; justify-content: space-between; align-items: flex-start;
        }

        .dev-indicator {
            position: absolute; top: 5px; left: 5px; color: #ff00ff;
            font-size: 10px; font-weight: bold; display: none; z-index: 100;
        }

        /* --- BUTTONS & INTERACTIVE --- */
        .game-btn, .big-btn, .secondary-btn {
            pointer-events: auto; cursor: pointer; text-transform: uppercase;
            font-family: inherit; box-shadow: 0 4px #000; color: white; border: 2px solid white;
        }
        .game-btn { background: #444; padding: 10px 15px; font-size: 10px; }
        .big-btn {
            background: var(--neon-green); color: #000; border: 4px solid #004400;
            padding: 15px 30px; font-size: 16px; margin: 10px; min-width: 200px;
            box-shadow: 0 6px #004400; transition: transform 0.1s;
        }
        .big-btn:active { transform: translateY(4px); box-shadow: 0 2px #004400; }
        .secondary-btn { background: #444; padding: 10px 20px; font-size: 10px; margin: 5px; }

        /* --- ENERGY BAR --- */
        .energy-wrapper { display: flex; flex-direction: column; align-items: flex-start; }
        .energy-container {
            width: 150px; height: 18px; background: #222; border: 2px solid #fff;
            transform: skewX(-15deg); box-shadow: 3px 3px 0px rgba(0,0,0,0.5);
            overflow: hidden; margin-top: 3px; position: relative;
        }
        .energy-bar {
            height: 100%; width: 100%;
            background: repeating-linear-gradient(45deg, #ffff00, #ffff00 10px, #d4af37 10px, #d4af37 20px);
            box-shadow: 0 0 15px #ffff00; transition: width 0.1s linear;
        }
        .energy-bar.critical {
            background: repeating-linear-gradient(45deg, #ff0000, #ff0000 10px, #990000 10px, #990000 20px);
            animation: pulse-critical 0.5s infinite alternate;
        }
        @keyframes pulse-critical { 0% { opacity: 1; } 100% { opacity: 0.6; } }

        /* --- SCREENS --- */
        .screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85); display: flex; flex-direction: column;
            justify-content: center; align-items: center; color: white;
            text-align: center; pointer-events: auto; z-index: 20; backdrop-filter: blur(2px);
        }
        .hidden { display: none !important; }

        .title-container h1 {
            font-size: 32px; color: var(--neon-green); margin: 0;
            text-shadow: 4px 4px 0 #004400; -webkit-text-stroke: 1px #fff;
        }
        .title-container { animation: float-title 3s ease-in-out infinite; cursor: pointer; }
        @keyframes float-title { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }

        /* --- CHARACTER SELECT --- */
        .char-select-container { 
            background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px;
            margin-bottom: 20px; border: 1px solid #444;
        }
        .bear-options { display: flex; gap: 20px; align-items: center; }
        .bear-option-wrapper {
            display: flex; flex-direction: column; align-items: center; cursor: pointer;
            opacity: 0.6; transition: all 0.2s;
        }
        .bear-option-wrapper:hover, .bear-option-wrapper.selected { opacity: 1; transform: scale(1.1); }
        .bear-option-wrapper.selected .bear-option { border-color: #fff; box-shadow: 0 0 10px #fff; }
        
        /* Bear CSS Art (Matches Canvas Art) */
        .bear-option {
            width: 44px; height: 40px; border-radius: 50%; border: 2px solid #222;
            position: relative; margin-bottom: 5px;
        }
        .bear-ear {
            position: absolute; top: -4px; width: 14px; height: 14px;
            background: inherit; border: 2px solid #222; border-radius: 50%; z-index: -1;
        }
        .bear-ear.left { left: -2px; } .bear-ear.right { right: -2px; }
        .bear-snout {
            position: absolute; bottom: 6px; left: 50%; transform: translateX(-50%);
            width: 18px; height: 14px; background: rgba(255,255,255,0.4); border-radius: 50%;
        }
        .bear-nose {
            position: absolute; top: 3px; left: 50%; transform: translateX(-50%);
            width: 8px; height: 6px; background: #111; border-radius: 50%;
        }
        .bear-eyes { position: absolute; top: 12px; left: 0; width: 100%; }
        .bear-eyes::before, .bear-eyes::after {
            content: ''; position: absolute; width: 5px; height: 5px; background: #111; border-radius: 50%;
        }
        .bear-eyes::before { left: 10px; } .bear-eyes::after { right: 10px; }

        /* Locked State */
        .bear-option-wrapper.locked { opacity: 0.4; filter: grayscale(100%); cursor: not-allowed; }
        .bear-option-wrapper.locked .bear-option::after {
            content: '?'; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); color: #444; font-size: 20px; font-weight: bold;
        }

        /* --- JOYSTICK & MOBILE --- */
        #joystick-container { position: absolute; pointer-events: none; z-index: 15; opacity: 0.6; }
        #joystick-base {
            position: absolute; width: 100px; height: 100px; border: 4px solid rgba(255,255,255,0.4);
            border-radius: 50%; transform: translate(-50%, -50%); background: rgba(0,0,0,0.1);
        }
        #joystick-knob {
            position: absolute; width: 40px; height: 40px; background: rgba(0, 255, 0, 0.8);
            border-radius: 50%; transform: translate(-50%, -50%); border: 2px solid white;
        }
        #mobile-dash-btn {
            position: absolute; bottom: 30px; right: 30px; width: 80px; height: 80px;
            border-radius: 50%; background: rgba(255, 255, 0, 0.3); border: 4px solid rgba(255, 255, 0, 0.6);
            color: #ffff00; display: flex; justify-content: center; align-items: center;
            pointer-events: auto; font-weight: bold; font-size: 14px; display: none;
        }
        @media (hover: none) and (pointer: coarse) { #mobile-dash-btn { display: flex; } }
        
        /* Report Card */
        .ai-verdict {
            font-family: 'Courier New', monospace; background: #222; border: 2px dashed var(--neon-green);
            padding: 15px; margin: 20px; max-width: 80%; color: var(--neon-green); font-size: 12px;
            text-align: left; position: relative;
        }
    </style>
</head>
<body>

    <div id="ui-layer">
        <div class="hud">
            <div id="dev-indicator" class="dev-indicator">DEV MODE ACTIVE</div>
            <div class="energy-wrapper">
                <div class="energy-label" style="color:var(--neon-yellow); font-size:10px; font-weight:bold;">⚡ CAFFEINE LEVEL</div>
                <div class="energy-container"><div id="energy-bar" class="energy-bar"></div></div>
            </div>
            <div style="display:flex; flex-direction:column; align-items:flex-end;">
                <div class="high-score-label">HI: <span id="high-score-val" style="color:var(--neon-green)">0</span></div>
                <div id="score-board">SCORE: <span id="score-val">0</span></div>
                <div id="combo-display" style="color:#ff00ff; font-size:12px; height:15px; margin-top:5px;"></div>
                <button id="pause-btn" class="game-btn" style="margin-top:10px;">PAUSE</button>
            </div>
        </div>
        <div id="mobile-dash-btn">DASH<br>⚡15</div>
    </div>

    <div id="joystick-container" class="hidden">
        <div id="joystick-base"></div>
        <div id="joystick-knob"></div>
    </div>

    <div id="start-screen" class="screen">
        <div class="title-container">
            <h1>CAFFEINE RUSH</h1>
            <div style="color:var(--neon-yellow); font-size:14px; margin-top:5px; letter-spacing:2px;">SUGAR CRASH EDITION</div>
        </div>
        <div id="main-menu-content">
             <div class="char-select-container">
                <p style="color: #fff; margin-bottom: 15px; font-size: 10px;">SELECT CHARACTER:</p>
                <div class="bear-options">
                    <div class="bear-option-wrapper selected" data-color="#00cc44" data-name="Green Bear">
                        <div class="bear-option" style="background: #00cc44;"><div class="bear-ear left"></div><div class="bear-ear right"></div><div class="bear-eyes"></div><div class="bear-snout"><div class="bear-nose"></div></div></div>
                        <div class="bear-name" style="font-size:8px; margin-top:5px; color:#fff;">GREEN</div>
                    </div>
                    <div class="bear-option-wrapper" data-color="#8B4513" data-name="Brown Bear">
                        <div class="bear-option" style="background: #8B4513;"><div class="bear-ear left"></div><div class="bear-ear right"></div><div class="bear-eyes"></div><div class="bear-snout"><div class="bear-nose"></div></div></div>
                        <div class="bear-name" style="font-size:8px; margin-top:5px; color:#aaa;">BROWN</div>
                    </div>
                    <div class="bear-option-wrapper" data-color="#0066ff" data-name="Blue Bear">
                        <div class="bear-option" style="background: #0066ff;"><div class="bear-ear left"></div><div class="bear-ear right"></div><div class="bear-eyes"></div><div class="bear-snout"><div class="bear-nose"></div></div></div>
                        <div class="bear-name" style="font-size:8px; margin-top:5px; color:#aaa;">BLUE</div>
                    </div>
                    <div class="bear-option-wrapper" data-color="#ff66b2" data-name="Pink Bear">
                        <div class="bear-option" style="background: #ff66b2;"><div class="bear-ear left"></div><div class="bear-ear right"></div><div class="bear-eyes"></div><div class="bear-snout"><div class="bear-nose"></div></div></div>
                        <div class="bear-name" style="font-size:8px; margin-top:5px; color:#aaa;">PINK</div>
                    </div>
                    <div id="secret-bear-option" class="bear-option-wrapper locked" data-color="#FFD700" data-name="Gold Bear">
                        <div class="bear-option" style="background: #FFD700;"><div class="bear-ear left"></div><div class="bear-ear right"></div><div class="bear-eyes"></div><div class="bear-snout"><div class="bear-nose"></div></div></div>
                        <div class="bear-name" style="font-size:8px; margin-top:5px; color:#aaa;">???</div>
                    </div>
                </div>
            </div>
            <button id="start-btn" class="big-btn">PLAY GAME</button><br>
            <button id="how-to-btn" class="secondary-btn">HOW TO PLAY</button>
        </div>
        <div id="how-to-screen" class="hidden" style="max-width: 500px;">
            <h3 style="color:var(--neon-yellow);">INSTRUCTIONS</h3>
            <ul style="text-align:left; color:#ccc; font-size:12px; line-height:1.6;">
                <li><strong>Goal:</strong> Stay awake! Drink soda.</li>
                <li><strong>Controls:</strong> Arrow Keys / WASD / Touch.</li>
                <li><strong>Dash:</strong> SPACE. Costs 15 Energy. Invincible!</li>
                <li><strong>Enemies:</strong> Dodge parents. Dash to knock them out.</li>
            </ul>
            <button id="back-menu-btn" class="secondary-btn">BACK</button>
        </div>
    </div>

    <div id="pause-screen" class="screen hidden">
        <h1>PAUSED</h1>
        <button id="resume-btn" class="big-btn">RESUME</button>
        <button id="quit-btn" class="big-btn" style="background: #ff4444; border-color: #880000;">MAIN MENU</button>
    </div>

    <div id="game-over-screen" class="screen hidden">
        <h1 id="go-title" style="color: #ff4444;">YOU GOT GROUNDED!</h1>
        <p id="death-reason" style="color:#ccc;">Ran out of energy...</p>
        <div id="ai-verdict-box" class="ai-verdict">Generating parental lecture...</div>
        <p>Final Score: <span id="final-score">0</span></p>
        <button id="restart-btn" class="big-btn">TRY AGAIN</button>
        <button id="go-menu-btn" class="secondary-btn">CHANGE BEAR</button>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        /**
         * CAFFEINE RUSH v0.07 (Visuals Restored)
         * Created by Green Bear & Gemini
         */

        // --- CONFIGURATION ---
        const CONFIG = {
            PHYSICS: {
                FRICTION: 0.85,
                ACCELERATION: 0.8,
                MAX_SPEED: 2.8,
                DASH_SPEED: 12,
                DASH_COST: 15,
                DASH_COOLDOWN: 60
            },
            GAME: {
                ENERGY_DRAIN: 0.05,
                SPAWN_RATE_ENEMY: 140,
                SPAWN_RATE_DRINK: 120,
            },
            COLORS: {
                PARTICLE_DEFAULT: '#fff',
                TEXT_FLOAT: '#fff',
                ENEMY_DAD: '#BBB',
                ENEMY_MOM: '#d68a8a'
            }
        };

        const STRINGS = {
            NAGS: [ "Go to bed!", "School night!", "Stop jumping!", "Eat veggies!", "Clean your room!" ],
            NAGS_BROWN: [ "Come here boy!", "Get back to work!", "Stop stealing!", "Get the rope!" ],
            VERDICTS: [
                "I'm not mad, just disappointed.", "Grounded for 100 years!", 
                "Bedtime was 3 hours ago.", "You call that an attempt?"
            ]
        };

        // --- UTILS ---
        const Utils = {
            rand: (min, max) => Math.random() * (max - min) + min,
            randItem: (arr) => arr[Math.floor(Math.random() * arr.length)],
            dist: (x1, y1, x2, y2) => Math.sqrt((x2-x1)**2 + (y2-y1)**2)
        };

        // --- INPUT HANDLER ---
        class InputHandler {
            constructor() {
                this.keys = {};
                this.joystick = { active: false, x: 0, y: 0, vecX: 0, vecY: 0, radius: 50 };
                this.bindEvents();
            }

            bindEvents() {
                window.addEventListener('keydown', e => {
                    this.keys[e.key] = true;
                    if (e.key === 'p' || e.key === 'P') Game.instance.togglePause();
                    if (e.key === ' ') Game.instance.player.tryDash();
                    if (e.key === '`') Game.instance.toggleDevMode();
                    
                    // Dev Shortcuts
                    if (Game.instance.devMode) {
                        if (e.key === '1') Game.instance.spawner.spawnEnemy();
                        if (e.key === '2') Game.instance.spawner.spawnDrink();
                        if (e.key === 'k') Game.instance.gameOver("KILLED BY DEV");
                        if (e.key === 'g') Game.instance.toggleGodMode();
                    }
                });
                window.addEventListener('keyup', e => this.keys[e.key] = false);

                // Touch
                const container = document.getElementById('joystick-container');
                const base = document.getElementById('joystick-base');
                const knob = document.getElementById('joystick-knob');

                window.addEventListener('touchstart', e => {
                    if (e.target.closest('button') || e.target.id === 'mobile-dash-btn') return;
                    if (!Game.instance.isPlaying) return;
                    e.preventDefault();
                    
                    const touch = e.touches[0];
                    this.joystick.active = true;
                    this.joystick.x = touch.clientX; 
                    this.joystick.y = touch.clientY;
                    
                    container.classList.remove('hidden');
                    base.style.left = knob.style.left = this.joystick.x + 'px';
                    base.style.top = knob.style.top = this.joystick.y + 'px';
                }, {passive: false});

                window.addEventListener('touchmove', e => {
                    if(!this.joystick.active) return;
                    e.preventDefault();
                    const touch = e.touches[0];
                    const dx = touch.clientX - this.joystick.x;
                    const dy = touch.clientY - this.joystick.y;
                    const dist = Math.min(Math.sqrt(dx*dx+dy*dy), this.joystick.radius);
                    const angle = Math.atan2(dy, dx);
                    
                    const knobX = this.joystick.x + Math.cos(angle) * dist;
                    const knobY = this.joystick.y + Math.sin(angle) * dist;
                    
                    knob.style.left = knobX + 'px';
                    knob.style.top = knobY + 'px';
                    
                    this.joystick.vecX = (knobX - this.joystick.x) / this.joystick.radius;
                    this.joystick.vecY = (knobY - this.joystick.y) / this.joystick.radius;
                }, {passive: false});

                window.addEventListener('touchend', e => {
                    if(e.touches.length === 0) {
                        this.joystick.active = false;
                        container.classList.add('hidden');
                        this.joystick.vecX = this.joystick.vecY = 0;
                    }
                });

                document.getElementById('mobile-dash-btn').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    Game.instance.player.tryDash();
                });
            }

            getVector() {
                let vx = 0, vy = 0;
                if (this.joystick.active) {
                    vx = this.joystick.vecX; vy = this.joystick.vecY;
                } else {
                    if (this.keys.ArrowUp || this.keys.w || this.keys.W) vy -= 1;
                    if (this.keys.ArrowDown || this.keys.s || this.keys.S) vy += 1;
                    if (this.keys.ArrowLeft || this.keys.a || this.keys.A) vx -= 1;
                    if (this.keys.ArrowRight || this.keys.d || this.keys.D) vx += 1;
                }
                return { x: vx, y: vy };
            }
        }

        // --- ENTITIES ---
        class Particle {
            constructor(x, y, color, speed = 10, size = 5) {
                this.x = x; this.y = y;
                this.vx = (Math.random() - 0.5) * speed;
                this.vy = (Math.random() - 0.5) * speed;
                this.life = 30 + Math.random() * 20;
                this.color = color;
                this.size = Math.random() * size + 2;
            }
            update() {
                this.x += this.vx; this.y += this.vy;
                this.life--; this.size *= 0.95;
            }
            draw(ctx) {
                ctx.fillStyle = this.color; ctx.beginPath(); 
                ctx.arc(this.x, this.y, Math.max(0, this.size), 0, Math.PI*2); ctx.fill();
            }
        }

        class Player {
            constructor(x, y, color) {
                this.x = x; this.y = y;
                this.vx = 0; this.vy = 0;
                this.radius = 20;
                this.color = color;
                this.shield = 0;
                this.isDashing = false;
                this.dashTimer = 0;
                this.dashCooldown = 0;
            }

            update(input) {
                // Dash Timer
                if (this.dashCooldown > 0) this.dashCooldown--;
                if (this.isDashing) {
                    this.dashTimer--;
                    Game.instance.particles.add(this.x, this.y, this.color, 1);
                    if (this.dashTimer <= 0) this.isDashing = false;
                }

                // Physics
                const inputVec = input.getVector();
                if(inputVec.x || inputVec.y) {
                    this.vx += inputVec.x * CONFIG.PHYSICS.ACCELERATION;
                    this.vy += inputVec.y * CONFIG.PHYSICS.ACCELERATION;
                }

                // Friction & Cap
                const fric = this.isDashing ? 0.95 : CONFIG.PHYSICS.FRICTION;
                this.vx *= fric; this.vy *= fric;

                if (!this.isDashing) {
                    const speed = Math.sqrt(this.vx**2 + this.vy**2);
                    if (speed > CONFIG.PHYSICS.MAX_SPEED) {
                        const ratio = CONFIG.PHYSICS.MAX_SPEED / speed;
                        this.vx *= ratio; this.vy *= ratio;
                    }
                }

                this.x += this.vx; this.y += this.vy;

                // Bounds
                const maxW = Game.instance.width;
                const maxH = Game.instance.height;
                if (this.x < this.radius) { this.x = this.radius; this.vx *= -0.5; }
                if (this.x > maxW - this.radius) { this.x = maxW - this.radius; this.vx *= -0.5; }
                if (this.y < this.radius) { this.y = this.radius; this.vy *= -0.5; }
                if (this.y > maxH - this.radius) { this.y = maxH - this.radius; this.vy *= -0.5; }
            }

            tryDash() {
                if (this.dashCooldown <= 0 && (Game.instance.energy >= CONFIG.PHYSICS.DASH_COST || Game.instance.godMode)) {
                    if (!Game.instance.godMode) Game.instance.energy -= CONFIG.PHYSICS.DASH_COST;
                    this.isDashing = true;
                    this.dashTimer = 15;
                    this.dashCooldown = CONFIG.PHYSICS.DASH_COOLDOWN;
                    
                    let len = Math.sqrt(this.vx**2 + this.vy**2);
                    if (len < 0.1) { this.vx = 0.1; len = 0.1; }
                    this.vx = (this.vx / len) * CONFIG.PHYSICS.DASH_SPEED;
                    this.vy = (this.vy / len) * CONFIG.PHYSICS.DASH_SPEED;

                    Game.instance.shake = 5;
                    Game.instance.particles.burst(this.x, this.y, '#fff', 10);
                }
            }

            draw(ctx) {
                ctx.save();
                ctx.translate(this.x, this.y);
                
                // Visual FX
                if (this.shield > 0) { ctx.beginPath(); ctx.arc(0,0,30,0,Math.PI*2); ctx.strokeStyle='cyan'; ctx.stroke(); }
                if (this.isDashing) { ctx.beginPath(); ctx.arc(0,0,25,0,Math.PI*2); ctx.fillStyle='rgba(255,255,255,0.4)'; ctx.fill(); }
                
                ctx.rotate(this.vx * 0.1);

                // Body
                ctx.fillStyle = this.color;
                ctx.beginPath(); ctx.arc(-12, -12, 8, 0, Math.PI*2); ctx.arc(12, -12, 8, 0, Math.PI*2); ctx.fill(); // Ears
                ctx.beginPath(); ctx.arc(0, 0, 20, 0, Math.PI*2); ctx.fill(); // Head
                
                // Snout
                ctx.fillStyle = (this.color === CONFIG.COLORS.GREEN) ? '#00aa33' : '#DDD';
                if(this.color === '#8B4513') ctx.fillStyle = '#6d340d';
                ctx.beginPath(); ctx.ellipse(0, 5, 8, 6, 0, 0, Math.PI*2); ctx.fill();
                
                // Nose
                ctx.fillStyle = '#111';
                ctx.beginPath(); ctx.arc(0, 3, 3, 0, Math.PI*2); ctx.fill();
                
                // Eyes
                ctx.fillStyle = 'white';
                ctx.beginPath(); ctx.arc(-6, -4, 5, 0, Math.PI*2); ctx.arc(6, -4, 5, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = 'black';
                ctx.beginPath(); ctx.arc(-6, -4, 2, 0, Math.PI*2); ctx.arc(6, -4, 2, 0, Math.PI*2); ctx.fill();

                ctx.restore();
            }
        }

        class Enemy {
            constructor(x, y, type, nagList) {
                this.x = x; this.y = y;
                this.type = type;
                this.size = 18;
                this.speed = Utils.rand(0.3, 0.7);
                this.angle = 0;
                this.nag = Utils.randItem(nagList);
                this.nagTimer = Utils.rand(0, 300);
                this.wobble = Math.random() * Math.PI * 2;
            }

            update(targetX, targetY) {
                const dx = targetX - this.x;
                const dy = targetY - this.y;
                let angle = Math.atan2(dy, dx);
                angle += Math.sin(Game.instance.frames * 0.05 + this.wobble) * 0.5;

                let spd = this.speed;
                if(Game.instance.slowTimer > 0) spd *= 0.5;

                this.x += Math.cos(angle) * spd;
                this.y += Math.sin(angle) * spd;
            }

            draw(ctx, playerX) {
                ctx.save();
                ctx.translate(this.x, this.y);
                
                if (playerX < this.x) ctx.scale(-1, 1);
                
                if (Game.instance.slowTimer > 0) { ctx.shadowColor = '#00FFFF'; ctx.shadowBlur = 10; }

                if (this.type === 'triangle') {
                    // Brown Bear Enemy
                    ctx.fillStyle = '#FFF'; ctx.strokeStyle='#999'; ctx.lineWidth=2;
                    ctx.beginPath(); ctx.moveTo(0, -this.size-5); ctx.lineTo(this.size, this.size); ctx.lineTo(-this.size, this.size); ctx.closePath();
                    ctx.fill(); ctx.stroke();
                    ctx.fillStyle = 'black'; ctx.beginPath(); ctx.arc(-6,2,3,0,Math.PI*2); ctx.arc(6,2,3,0,Math.PI*2); ctx.fill();
                } else {
                    // Family Members
                    const colors = { dad: '#BBB', mom: '#d68a8a', grandma: '#a8b9bf', uncle: '#556B2F', cousin: '#CD5C5C', neighbor: '#9370DB' };
                    ctx.fillStyle = colors[this.type] || '#BBB';
                    
                    ctx.beginPath(); ctx.arc(0,0,this.size,0,Math.PI*2); ctx.fill(); ctx.stroke();
                    
                    if (this.type === 'mom') {
                        ctx.fillStyle = colors.mom;
                        ctx.beginPath(); ctx.arc(0, -this.size+2, 8, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                    }
                    if (this.type === 'grandma') {
                         ctx.fillStyle = '#fff';
                         ctx.beginPath(); ctx.arc(0, 0, this.size-1, Math.PI, 0); ctx.fill();
                    }

                    ctx.fillStyle='white'; ctx.beginPath(); ctx.arc(-7,-2,4,0,Math.PI*2); ctx.arc(7,-2,4,0,Math.PI*2); ctx.fill();
                    ctx.fillStyle='black'; ctx.beginPath(); ctx.arc(-7,-2,2,0,Math.PI*2); ctx.arc(7,-2,2,0,Math.PI*2); ctx.fill();
                    
                    if (['dad', 'mom', 'grandma', 'uncle'].includes(this.type)) {
                        ctx.strokeStyle='#333'; ctx.lineWidth=1.5; 
                        ctx.beginPath(); ctx.arc(-7,-2,6,0,Math.PI*2); ctx.arc(7,-2,6,0,Math.PI*2); ctx.stroke();
                    }
                    
                    ctx.strokeStyle = '#000'; ctx.lineWidth=2; ctx.beginPath();
                    if (this.type === 'uncle') {
                         // Bushy Eyebrows
                        ctx.lineWidth=3; ctx.beginPath(); ctx.moveTo(-10, -8); ctx.lineTo(-2, -8); ctx.stroke();
                        ctx.beginPath(); ctx.moveTo(2, -8); ctx.lineTo(10, -8); ctx.stroke();
                        // Frown
                        ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(-5, 10); ctx.lineTo(5, 10); ctx.stroke();
                    } else if (this.type === 'cousin') {
                        ctx.beginPath(); ctx.arc(0, 5, 5, 0, Math.PI); ctx.stroke();
                    } else if (this.type === 'neighbor') {
                        ctx.beginPath(); ctx.arc(0, 8, 3, 0, Math.PI*2); ctx.stroke();
                    } else {
                        ctx.beginPath(); ctx.arc(0, 10, 6, Math.PI, 2*Math.PI); ctx.stroke();
                    }

                    if (this.type === 'dad') {
                        ctx.fillStyle = '#cc0000'; ctx.beginPath(); 
                        ctx.moveTo(0, this.size-5); ctx.lineTo(-3, this.size+5); ctx.lineTo(3, this.size+5); ctx.fill();
                    }
                }

                if (Game.instance.frames % 600 > this.nagTimer && Game.instance.frames % 600 < this.nagTimer + 240) {
                    if (playerX < this.x) ctx.scale(-1, 1);
                    ctx.font = '10px Arial'; ctx.fillStyle = 'white'; ctx.textAlign = 'center'; 
                    ctx.fillText(this.nag, 0, -this.size-10);
                }

                ctx.restore();
            }
        }

        class Drink {
            constructor(x, y, type) {
                this.x = x; this.y = y;
                this.type = type; 
                this.size = 15;
                this.life = 1000;
                this.scale = 0;
            }
            update() {
                if(this.scale < 1) this.scale += 0.1;
                this.life--;
            }
            draw(ctx) {
                ctx.save(); ctx.translate(this.x, this.y); ctx.scale(this.scale, this.scale);
                
                // RESTORED DESIGN: Shake only on expire
                if (this.life < 180) ctx.translate((Math.random()-0.5)*3, (Math.random()-0.5)*3); 
                
                const w = 16, h = 24;
                const colors = {
                    normal: ['#102d78', '#00ff00', 'E'],
                    shield: ['#0077aa', '#00ccff', 'S'],
                    mega: ['#aa00aa', '#ff00ff', 'M'],
                    multiplier: ['#DAA520', '#FFD700', 'X2'],
                    slow: ['#008B8B', '#00FFFF', '❄️'],
                    watermelon: ['#00aa00', '#ff3333', '']
                };
                const style = colors[this.type] || colors.normal;

                if (this.type === 'watermelon') {
                    ctx.fillStyle = style[0]; ctx.beginPath(); ctx.arc(0, 0, 12, 0, Math.PI, false); ctx.fill();
                    ctx.fillStyle = style[1]; ctx.beginPath(); ctx.arc(0, 0, 8, 0, Math.PI, false); ctx.fill();
                    ctx.fillStyle = 'black'; [-3,0,3].forEach(o=> { ctx.beginPath(); ctx.arc(o, 4, 1, 0, Math.PI*2); ctx.fill(); });
                } else {
                    // RESTORED DESIGN: Glowing Aura for Specials
                     if (this.type === 'multiplier' || this.type === 'slow') {
                        ctx.strokeStyle = style[1]; ctx.lineWidth = 2; 
                        ctx.globalAlpha = 0.6 + Math.sin(Game.instance.frames * 0.1) * 0.4;
                        ctx.strokeRect(-w/2-3, -h/2-3, w+6, h+6); 
                        ctx.globalAlpha = 1;
                    }

                    // RESTORED DESIGN: Specific Checkerboard for Normal
                    if (this.type === 'normal') {
                        ctx.fillStyle = '#102d78'; ctx.fillRect(-w/2, -h/2, w, h);
                        ctx.fillStyle = '#d4d8db'; ctx.fillRect(-w/2, -h/2, w/2, h/2); ctx.fillRect(0, 0, w/2, h/2);
                    } else {
                        ctx.fillStyle = style[0]; ctx.fillRect(-w/2, -h/2, w, h);
                    }

                    // RESTORED DESIGN: Rounded Bottoms
                    ctx.fillStyle = '#ccc'; ctx.beginPath(); ctx.ellipse(0, -h/2, w/2, 3, 0, 0, Math.PI*2); ctx.fill(); ctx.stroke();
                    ctx.fillStyle = (this.type === 'normal') ? '#102d78' : style[0]; // Body Color for bottom curve
                    if(this.type === 'normal') ctx.fillStyle = '#102d78'; // Override for checkerboard bottom
                    
                    ctx.beginPath(); ctx.ellipse(0, h/2, w/2, 3, 0, 0, Math.PI, 0); ctx.fill();
                    
                    ctx.fillStyle = style[1]; ctx.font = '8px Arial'; ctx.textAlign='center'; ctx.textBaseline='middle'; ctx.fillText(style[2], 0, 0);
                }

                ctx.restore();
            }
        }

        // --- MANAGERS ---
        class ParticleSystem {
            constructor() {
                this.list = [];
                this.floats = [];
                this.shockwaves = [];
            }
            add(x, y, color, count=1) {
                for(let i=0; i<count; i++) this.list.push(new Particle(x, y, color));
            }
            burst(x, y, color, count=10) { this.add(x, y, color, count); }
            addFloat(x, y, text, color) { this.floats.push({x, y, text, color, life: 60, vy: -1}); }
            addShockwave(x, y) { this.shockwaves.push({x, y, r:0, alpha:1}); }

            updateAndDraw(ctx) {
                // Particles
                for (let i = this.list.length - 1; i >= 0; i--) {
                    let p = this.list[i];
                    p.update(); p.draw(ctx);
                    if(p.life <= 0) this.list.splice(i, 1);
                }
                // Floating Text
                for (let i = this.floats.length - 1; i >= 0; i--) {
                    let f = this.floats[i];
                    f.y += f.vy; f.life--;
                    if(f.life <= 0) { this.floats.splice(i, 1); continue; }
                    ctx.font = 'bold 12px Arial'; ctx.fillStyle = f.color;
                    ctx.globalAlpha = f.life/60; ctx.fillText(f.text, f.x, f.y); ctx.globalAlpha = 1;
                }
                // Shockwaves
                for (let i = this.shockwaves.length - 1; i >= 0; i--) {
                    let s = this.shockwaves[i];
                    s.r += 20; s.alpha -= 0.05;
                    if(s.alpha <= 0) { this.shockwaves.splice(i, 1); continue; }
                    ctx.save(); ctx.beginPath(); ctx.arc(Game.instance.player.x, Game.instance.player.y, s.r, 0, Math.PI*2);
                    ctx.strokeStyle = `rgba(255,255,255,${s.alpha})`; ctx.lineWidth=10; ctx.stroke(); ctx.restore();
                }
            }
            clear() { this.list = []; this.floats = []; this.shockwaves = []; }
        }

        class Spawner {
            constructor() { this.frames = 0; }
            update() {
                this.frames++;
                if (this.frames % Math.max(50, CONFIG.GAME.SPAWN_RATE_ENEMY - Game.instance.difficulty) === 0) this.spawnEnemy();
                if (this.frames % CONFIG.GAME.SPAWN_RATE_DRINK === 0) this.spawnDrink();
                if (this.frames % 1200 === 0) this.spawnDrink('multiplier');
            }
            spawnEnemy() {
                const g = Game.instance;
                const edge = Math.floor(Math.random() * 4);
                let x, y, buf = 50;
                if (edge===0) { x = Utils.rand(0, g.width); y = -buf; }
                else if (edge===1) { x = g.width + buf; y = Utils.rand(0, g.height); }
                else if (edge===2) { x = Utils.rand(0, g.width); y = g.height + buf; }
                else { x = -buf; y = Utils.rand(0, g.height); }

                let type = 'dad';
                let nags = STRINGS.NAGS;

                if (g.player.color === '#8B4513') {
                    type = 'triangle'; nags = STRINGS.NAGS_BROWN;
                } else {
                    const types = ['dad', 'mom', 'grandma', 'uncle', 'cousin', 'neighbor'];
                    type = Utils.randItem(types);
                }
                g.enemies.push(new Enemy(x, y, type, nags));
            }
            spawnDrink(forcedType) {
                const g = Game.instance;
                const margin = 50;
                const x = Utils.rand(margin, g.width - margin);
                const y = Utils.rand(margin, g.height - margin);
                let type = forcedType || 'normal';
                
                if (!forcedType) {
                    const r = Math.random();
                    if (r > 0.95) type = 'mega';
                    else if (r > 0.90) type = 'shield';
                    else if (r > 0.85 && g.slowCooldown <= 0) type = 'slow';
                }
                if (g.player.color === '#8B4513') type = 'watermelon';
                g.drinks.push(new Drink(x, y, type));
            }
        }

        // --- CORE GAME ENGINE ---
        class Game {
            constructor() {
                Game.instance = this;
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.resize();
                
                this.input = new InputHandler();
                this.particles = new ParticleSystem();
                this.spawner = new Spawner();
                
                this.player = new Player(this.width/2, this.height/2, '#00cc44');
                this.enemies = [];
                this.drinks = [];
                
                this.isPlaying = false;
                this.isPaused = false;
                this.devMode = false;
                this.godMode = false;
                
                this.score = 0;
                this.highScore = localStorage.getItem('crush_hs') || 0;
                this.frames = 0;
                this.energy = 100;
                this.difficulty = 1;
                this.shake = 0;
                
                this.combo = 0;
                this.comboTimer = 0;
                this.multiplier = 1;
                this.multiplierTimer = 0;
                this.slowTimer = 0;
                this.slowCooldown = 0;

                this.secretUnlocked = localStorage.getItem('crush_secret') === 'true';

                this.ui = {
                    score: document.getElementById('score-val'),
                    highScore: document.getElementById('high-score-val'),
                    combo: document.getElementById('combo-display'),
                    energy: document.getElementById('energy-bar'),
                    screens: {
                        start: document.getElementById('start-screen'),
                        pause: document.getElementById('pause-screen'),
                        gameOver: document.getElementById('game-over-screen'),
                        howTo: document.getElementById('how-to-screen'),
                        menuContent: document.getElementById('main-menu-content')
                    },
                    dev: document.getElementById('dev-indicator')
                };
                
                this.ui.highScore.innerText = this.highScore;
                this.bindUI();
                if(this.secretUnlocked) this.unlockSecretVisuals();

                this.loop();
            }

            resize() {
                this.width = this.canvas.width = window.innerWidth;
                this.height = this.canvas.height = window.innerHeight;
            }

            bindUI() {
                document.getElementById('start-btn').onclick = () => this.start();
                document.getElementById('restart-btn').onclick = () => this.start();
                document.getElementById('pause-btn').onclick = () => this.togglePause();
                document.getElementById('resume-btn').onclick = () => this.togglePause();
                document.getElementById('quit-btn').onclick = () => this.toMenu();
                document.getElementById('go-menu-btn').onclick = () => this.toMenu();
                
                document.getElementById('how-to-btn').onclick = () => {
                   this.ui.screens.menuContent.classList.add('hidden');
                   this.ui.screens.howTo.classList.remove('hidden');
                };
                document.getElementById('back-menu-btn').onclick = () => {
                   this.ui.screens.howTo.classList.add('hidden');
                   this.ui.screens.menuContent.classList.remove('hidden');
                };

                document.querySelectorAll('.bear-option-wrapper').forEach(opt => {
                    opt.onclick = (e) => {
                        e.stopPropagation();
                        if (opt.classList.contains('locked')) return;
                        document.querySelectorAll('.bear-option-wrapper').forEach(o => o.classList.remove('selected'));
                        opt.classList.add('selected');
                        this.player.color = opt.dataset.color;
                    };
                });
                
                let clicks = 0;
                document.querySelector('.title-container').onclick = () => {
                    clicks++;
                    if(clicks >= 5) { this.toggleDevMode(); clicks = 0; }
                };
            }

            start() {
                this.isPlaying = true; this.isPaused = false;
                this.score = 0; this.energy = 100; this.frames = 0; this.difficulty = 1;
                this.combo = 0; this.multiplier = 1;
                
                this.player.x = this.width/2; this.player.y = this.height/2;
                this.player.vx = 0; this.player.vy = 0;
                this.player.shield = 0;
                
                this.enemies = []; this.drinks = [];
                this.particles.clear();
                
                this.ui.screens.start.classList.add('hidden');
                this.ui.screens.gameOver.classList.add('hidden');
                this.ui.screens.pause.classList.add('hidden');
                this.ui.energy.style.width = '100%';
                
                this.spawner.spawnDrink();
                this.spawner.spawnDrink();
            }

            toMenu() {
                this.isPlaying = false; this.isPaused = false;
                this.ui.screens.start.classList.remove('hidden');
                this.ui.screens.gameOver.classList.add('hidden');
                this.ui.screens.pause.classList.add('hidden');
            }

            togglePause() {
                if(!this.isPlaying) return;
                this.isPaused = !this.isPaused;
                this.ui.screens.pause.classList.toggle('hidden', !this.isPaused);
            }

            gameOver(reason) {
                this.isPlaying = false;
                if(this.score > this.highScore) {
                    this.highScore = this.score;
                    localStorage.setItem('crush_hs', this.highScore);
                    this.ui.highScore.innerText = this.highScore;
                }
                
                const title = document.getElementById('go-title');
                const verdict = document.getElementById('ai-verdict-box');
                
                if (this.player.color === '#8B4513') {
                    title.innerText = "BACK TO WORK!";
                    verdict.style.display = 'none';
                    if (this.score >= 1000 && !this.secretUnlocked) {
                        this.secretUnlocked = true;
                        localStorage.setItem('crush_secret', 'true');
                        alert("✨ GOLDEN BEAR UNLOCKED! ✨");
                        this.unlockSecretVisuals();
                    }
                } else {
                    title.innerText = "YOU GOT GROUNDED!";
                    verdict.style.display = 'block';
                    verdict.innerText = Utils.randItem(STRINGS.VERDICTS);
                }

                document.getElementById('death-reason').innerText = reason;
                document.getElementById('final-score').innerText = this.score;
                this.ui.screens.gameOver.classList.remove('hidden');
            }
            
            unlockSecretVisuals() {
                const el = document.getElementById('secret-bear-option');
                el.classList.remove('locked');
                el.querySelector('.bear-name').innerText = 'GOLD';
            }

            addScore(pts) {
                const comboBonus = 1 + (this.combo * 0.1);
                this.score += Math.floor(pts * this.multiplier * comboBonus);
                this.ui.score.innerText = this.score;
            }

            update() {
                if(this.isPaused) return;
                this.frames++;
                
                if (this.multiplierTimer > 0) { this.multiplierTimer--; if(this.multiplierTimer===0) this.multiplier = 1; }
                if (this.slowTimer > 0) this.slowTimer--;
                if (this.slowCooldown > 0) this.slowCooldown--;
                if (this.combo > 0) {
                    this.comboTimer--;
                    if(this.comboTimer <= 0) { this.combo = 0; this.ui.combo.innerText = ""; }
                }

                if (this.shake > 0) this.shake *= 0.9;
                if (this.shake < 0.5) this.shake = 0;

                this.player.update(this.input);

                if(!this.godMode) {
                    this.energy -= CONFIG.GAME.ENERGY_DRAIN;
                    if(this.energy <= 0) this.gameOver("Fell asleep standing up...");
                    this.ui.energy.style.width = Math.max(0, this.energy) + '%';
                    if(this.energy < 25) { 
                        this.ui.energy.classList.add('critical'); 
                        document.querySelector('.energy-label').style.color = '#ff0000';
                    } else { 
                        this.ui.energy.classList.remove('critical');
                        document.querySelector('.energy-label').style.color = '#ffff00';
                    }
                }

                this.spawner.update();

                this.drinks.forEach((d, i) => {
                    d.update();
                    if(Utils.dist(this.player.x, this.player.y, d.x, d.y) < this.player.radius + d.size) {
                        this.collectDrink(d);
                        this.drinks.splice(i, 1);
                    } else if (d.life <= 0) this.drinks.splice(i, 1);
                });

                this.enemies.forEach((e, i) => {
                    e.update(this.player.x, this.player.y);
                    if(Utils.dist(this.player.x, this.player.y, e.x, e.y) < this.player.radius + e.size - 5) {
                        this.hitEnemy(e, i);
                    }
                });
            }

            collectDrink(d) {
                this.combo++;
                this.comboTimer = 120;
                this.ui.combo.innerText = `COMBO x${this.combo}!`;
                this.particles.addFloat(d.x, d.y, `x${this.combo}`, '#fff');

                if (d.type === 'shield') {
                    this.player.shield += 3;
                    this.particles.burst(d.x, d.y, 'cyan', 15);
                } else if (d.type === 'mega') {
                    this.particles.addShockwave(d.x, d.y);
                    this.enemies.forEach(e => { this.particles.burst(e.x, e.y, 'red'); this.addScore(50); });
                    this.enemies = [];
                } else if (d.type === 'multiplier') {
                    this.multiplier = 2; this.multiplierTimer = 300;
                    this.particles.burst(d.x, d.y, 'gold');
                    this.particles.addFloat(d.x, d.y, "X2 SCORE", "gold");
                } else if (d.type === 'slow') {
                    this.slowTimer = 900; this.slowCooldown = 4500;
                    this.particles.burst(d.x, d.y, 'cyan');
                } else {
                    this.energy = Math.min(100, this.energy + 20);
                    this.particles.burst(d.x, d.y, 'yellow', 10);
                }
                this.addScore(50);
            }

            hitEnemy(e, index) {
                if (this.player.isDashing || this.godMode) {
                    this.particles.burst(e.x, e.y, 'orange', 15);
                    this.particles.addFloat(e.x, e.y, "SMASH!", "orange");
                    this.enemies.splice(index, 1);
                    this.shake = 10;
                    this.addScore(100);
                } else if (this.player.shield > 0) {
                    this.player.shield--;
                    this.particles.burst(e.x, e.y, 'cyan', 10);
                    this.enemies.splice(index, 1);
                } else if (this.slowTimer > 0) {
                     this.particles.burst(e.x, e.y, 'cyan', 10);
                     this.enemies.splice(index, 1);
                } else {
                    this.gameOver(this.player.color === '#8B4513' ? "Master caught you!" : "Parent caught you!");
                }
            }

            draw() {
                this.ctx.save();
                if(this.shake > 0) this.ctx.translate((Math.random()-0.5)*this.shake, (Math.random()-0.5)*this.shake);
                
                this.ctx.fillStyle = '#1a1a1a';
                this.ctx.fillRect(0, 0, this.width, this.height);

                if (this.isPlaying) {
                    this.particles.updateAndDraw(this.ctx); 
                    this.drinks.forEach(d => d.draw(this.ctx));
                    this.enemies.forEach(e => e.draw(this.ctx, this.player.x));
                    this.player.draw(this.ctx);

                    if(this.multiplier > 1) {
                         this.ctx.font = '20px "Press Start 2P"'; this.ctx.fillStyle = 'gold'; 
                         this.ctx.textAlign='center'; this.ctx.fillText("SCORE X2", this.width/2, 50);
                    }
                    if(this.slowTimer > 0) {
                         this.ctx.font = '20px "Press Start 2P"'; this.ctx.fillStyle = 'cyan'; 
                         this.ctx.textAlign='center'; this.ctx.fillText("FREEZE", this.width/2, 80);
                    }

                } else {
                    // Menu Background FX - RESTORED FLOATING PARTICLES
                    if(this.frames % 20 === 0) this.particles.add(Math.random()*this.width, this.height+10, '#333');
                    this.particles.list.forEach(p => { 
                        p.y-=1; 
                        this.ctx.fillStyle = 'rgba(50,50,50,0.5)'; this.ctx.beginPath(); this.ctx.arc(p.x, p.y, p.size, 0, Math.PI*2); this.ctx.fill(); 
                    });
                    
                    this.player.x = this.width/2; 
                    this.player.y = this.height/2 + Math.sin(this.frames*0.05)*5;
                    this.player.draw(this.ctx);
                }
                
                this.ctx.restore();
            }

            loop() {
                if(this.isPlaying) this.update();
                this.draw();
                requestAnimationFrame(() => this.loop());
            }

            toggleDevMode() {
                this.devMode = !this.devMode;
                this.godMode = this.devMode;
                this.ui.dev.style.display = this.devMode ? 'block' : 'none';
                this.ui.dev.innerText = `DEV MODE | GOD: ${this.godMode}`;
            }
            toggleGodMode() {
                this.godMode = !this.godMode;
                if(this.devMode) this.ui.dev.innerText = `DEV MODE | GOD: ${this.godMode}`;
            }
        }

        // --- INIT ---
        window.onload = () => new Game();
        window.onresize = () => Game.instance && Game.instance.resize();

    </script>
</body>
</html>
